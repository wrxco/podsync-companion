services:
  podsync:
    image: ghcr.io/wrxco/podsync:filename-template
    container_name: podsync
    restart: unless-stopped
    environment:
      PODSYNC_CONFIG_PATH: /app/config.toml
    volumes:
      - ./podsync/data:/app/data
      - ./podsync/db:/app/db
      - ./podsync/config.toml:/app/config.toml:ro

  podsync-companion:
    build:
      context: .
    container_name: podsync-companion
    restart: unless-stopped
    environment:
      - COMPANION_DB_URL=sqlite:////data/companion.db
      - COMPANION_SOURCE_DIR=/data/source
      - COMPANION_MEDIA_DIR=/data/media
      - COMPANION_POLL_INTERVAL_SECONDS=3
      - COMPANION_CHANNEL_SCAN_LIMIT=200
      - COMPANION_INDEX_COMMAND_TIMEOUT_SECONDS=1800
      # Set this to your public HTTPS URL when behind a reverse proxy.
      - COMPANION_PUBLIC_BASE_URL=https://podsync-companion.example.com
      - COMPANION_MEDIA_URL_PATH=/media
      - COMPANION_MANUAL_FEED_PATH=/feeds/manual.xml
      - COMPANION_MANUAL_FEED_FILE=/data/manual.xml
      - COMPANION_MANUAL_FEED_TITLE=Podsync Companion Manual Feed
      - COMPANION_MANUAL_FEED_DESCRIPTION=Manually selected back-catalog episodes
      - COMPANION_MERGED_FEED_PATH_PREFIX=/feeds/merged
      - COMPANION_MERGED_FEED_DIR=/data/merged
      - COMPANION_MERGED_FEED_TITLE_SUFFIX=Merged Feed
      - COMPANION_DOWNLOAD_AUDIO=true
      - COMPANION_PODSYNC_CONFIG_PATH=/podsync/config.toml
      - COMPANION_PODSYNC_DATA_DIR=/podsync/data
      - COMPANION_PODSYNC_FEED_SYNC_INTERVAL_SECONDS=300
      - COMPANION_AUTH_REQUIRED=true
      - COMPANION_BASIC_AUTH_USERNAME=change-me
      - COMPANION_BASIC_AUTH_PASSWORD=change-me-strong-password
      - COMPANION_CSRF_PROTECTION_ENABLED=true
      - COMPANION_CSRF_HEADER_NAME=x-companion-csrf
      - COMPANION_CSRF_HEADER_VALUE=1
      - COMPANION_API_MUTATION_RATE_LIMIT_PER_MINUTE=60
    ports:
      # Safer default: local bind only; expose publicly through TLS reverse proxy.
      - "127.0.0.1:8080:8080"
    volumes:
      - ./companion-data:/data
      - ./podsync/config.toml:/podsync/config.toml:ro
      - ./podsync/data:/podsync/data:ro
